<!DOCTYPE html>
<html lang="en">

<head>
    <title>GMU Computer Science Department</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- Title page.  -->
    <h1>GMU Computer Science Dept. Survey</h1>
    
    <!-- User greeting. -->
    <script type="text/javascript">

        // Grab today's date.
        var now = new Date();
        var hour = now.getHours();
        var name;

        // Start of writing greeting.
        document.write("<h3> ")

        // Distinguish time of day.
        if (hour < 12)
            document.write("Good Morning ")
        else{
            hour -= 12

            if (hour<6){
                document.write("Good Afternoon ");
            }
            else
                document.write("Good Evening ");
        }

        // Find the name from cookie.
        if (document.cookie){ // if cookie exists

            // Convert escapd characters to English notation
            var myCookie = unescape(document.cookie);

            // Split the token and grab the name from cookie.
            var cookieTokens = myCookie.split("=");

            name = cookieTokens[1];

        } else{ // Cookie doesn't exists
            name = window.prompt("Please enter your name");

            document.cookie = "name=" + escape(name);

        }

        document.writeln(name + ", welcome to SWE642 survey. </h3>");

        // Wrong ID/cookie script.
        document.writeln("<a href='javascript:wrongID()'>" + "Click here to change user. Current User:" + name + "<\a>" );

        function wrongID(){
            // Erase cookie
            document.cookie = "name=null;" + " expires=Thu, 01-Jan-95 00:00:01 GMT";

            // Reload page.
            location.reload();
        }

    </script>
    <!-- END OF Greeting. -->
</head>

<body>

    <div class="container-fluid">


        <!-- Start of form. -->
        <p><strong>Required fields are marked with *</strong></p>
        <div class="degree_form">
            <form autocomplete="on">
                <!--Username-->
                <label> Username* </label>
                <input type="text" id="username" name="username" required autofocus="True" />
                <label> First Name*</label>
                <input type="text" id="first_name_input" name="first_name" required/>
                <label> Last Name*</label>
                <input type="text" id="last_name_input" name="last_name" required/>
                <label for="grad_month">Graduation Date*
                    <!-- graduation month -->
                    <input type="text" placeholder="Select a month" list="months" required />
                    <datalist id="months">
                        <option value="January">
                        <option value="February">
                        <option value="March">
                        <option value="April">
                        <option value="May">
                        <option value="June">
                        <option value="July">
                        <option value="August">
                        <option value="September">
                        <option value="October">
                        <option value="November">
                        <option value="December">

                    </datalist>

                    <!-- graduation year -->
                    <input type="text" placeholder="####" id="grad_year_input" required>
                </label>


                <!-- Address info-->
                <br />
                <label>Street Address*</label>
                <input type="text" name="streetaddress" id = "street_address_input" required />
                <label>City* </label>
                <input type="text" name="city" id="city_input" required />
                <label>State* </label>
                <input type="text" name="state" id="state_input"" required />

                <label>Zip Code* </label>
                <input type="text" name="zip_code" id="zip_input" onblur="validateZip(this.value)" required />
                <label id="validateZip" > </label> 

                <!--Email and Telephone #-->
                <br />
                <label>Email*</label>
                <input type="email" name="email" id="email_input" placeholder="name@domain.com" required />

                <label> Telephone #*</label>
                <input type="tel" placeholder="(###) ###-####" name="telephone_num" pattern="\(\d{3}\) +\d{3}-\d{4}"
                    required />

                <!--URL and Survey Date-->
                <br />
                <label>URL</label>
                <input type="url" placeholder="http://www.domain.com">

                <label>Date of Survey*</label>
                <input type="date" required>

                <!--Likes-->
                <br />
                <label>What do you like about the campus?*</label>
                <input type=checkbox name="likes" value="student"/> <label> Student </label> 
                <input type=checkbox name="likes" value="location"/> <label> Location </label> 
                <input type=checkbox name="likes" value="campus"/> <label> Campus </label> 
                <input type=checkbox name="likes" value="atmosphere"/> <label> Atmosphere </label> 
                <input type=checkbox name="likes" value="dorms"/> <label> Dorms </label> 
                <input type=checkbox name="likes" value="sports"/> <label> Sports </label> 

                <!--Interests-->
                <br />
                <label>
                    What made you interested with George Mason University?*</label>
                <input type=radio name="interests" value="friends" required />
                <label>Friends</label>
                <input type=radio name="interests" value="tv" />
                <label>TV</label>
                <input type=radio name="interests" value="internet" />
                <label>Internet</label>
                <input type=radio name="interests" value="other" />
                <label>Others</label>

                <!--Recommendation-->
                <br />
                <label> How likely are you going to recommend the school?*</label>

                <select name="rating" required>

                    <option>Very Likely</option>
                    <option>Likely</option>
                    <option>Unlikely</option>
                </select>

                <!--Raffle-->
                <br />
                <label>Raffle (Ten Numbers between [1,100])</label>
                <input type="text" name="raffle" id="raffle_num" placeholder="#,#,#,#,#,#,#,#,#,#" onchange="raffle_handler()"/>

                <!-- Average and Max of Raffle labels. -->
                <br />
                <label id="avg_output_lbl">  </label>
                <label id="max_output_lbl">  </label>

                <!--Additional Comments-->
                <br />
                <label>Comments</label> <br />
                <textarea rows="4" cols="36" placeholder="Enter Comments here."></textarea>

                <!-- BUTTONS -->
                <!--Submit button.-->
                <br />
                <input type="submit" value="Submit" onclick="submit_form_handler()" />

                <!--ResetButton-->
                <input type="reset" />

                <!-- Cancel Button -->
                <button onclick="window.location.href='./cs_dept.html'">
                    Cancel
                </button>
            </form>
        </div>

    </div>

    <!-- Start of JS -->
    <script type="text/javascript">

        /**
         * Raffle Handler when the input is changed.
         */
        function raffle_handler() {
            var html_obj = document.getElementById("raffle_num");
            
            var num_array = process_raffle_input(html_obj);

            // Error encountered.
            if (typeof num_array === "string"){
                alert(num_array);
                return;
            }
            
            // Process num_array and display it into HTML output.
            generate_raffle_output(num_array);

        }

        /**
         * Process raffle object and return the int array (int []).
         * Returns:
         *    - string if Error recieved, return error message.
         *    - int[] - If operation is sucessful.
         */
        function process_raffle_input(html_obj){
            
            input_string = html_obj.value;
            var num_tokens = input_string.split(",");
            
            // Validate token size.
            var error_msg = "";
            
            if(num_tokens.length < 10){
                // alert("Invalid raffle input length.");
                error_msg = "Invalid raffle input length."
                return error_msg;
            }
            
            var output_array = [] 
            // Process string to array of ints.
            for (var i = 0; i<num_tokens.length; i++){
                output_array[i] = parseInt(num_tokens[i]);

                // Exception handling - Validate text input.
                if(output_array[i] == NaN){
                    error_msg = "One of the raffle input is not a number."
                    

                    return error_msg;
                }

                if(output_array[i] < 1 || output_array[i] > 100){
                    error_msg = "Output " + output_array[i] + " is not within the range [0,100]";
                    // html_object.value = "";
                    return error_msg;
                }

            }

            return output_array;

        }

        /**
         * Process the HTML output for the Raffle. Currently supports average and max. 
         */
        function generate_raffle_output(num_array){
            // Calculate the max and average number.
            var max_num = Math.max.apply(null, num_array);

            // Sum
            const f_array_avg = array => array.reduce((a,b) => a+b) / array.length; 

            var avg_num = f_array_avg(num_array);
            
            // HTML OUTPUT.
            // Reassign average label.
            document.getElementById('avg_output_lbl').innerHTML = "Raffle Average Number: " + avg_num;

            // Reassign max label.
            document.getElementById('max_output_lbl').innerHTML = " Raffle Max Number: " + max_num;


        }

        function submit_form_handler(){

            validate_form();

        }

        /**
         * Validate certain fields from the form.
         */
        function validate_form(){
            
            validate_name_field();
            validate_grad_year();
            validate_address();
            validate_email_field();
            validate_likes_field();


        }

        function validate_name_field(){

            // if first name doesn't have letters only.
            first_name_str = document.getElementById("first_name_input").value;
            if (!/^[a-zA-Z]+$/.test(first_name_str)){

                alert("First name can only contain alphanumeric values.");
                
                // Clear first name input field.
                document.getElementById("first_name_input").value = "";
                
            }

            // If last name doesn't have letters only.
            last_name_str = document.getElementById("last_name_input").value;
            if (!/^[a-zA-Z]+$/.test(last_name_str)) {
                alert("Last name can only contain alphanumeric values.");

                // Clear last name input field.
                document.getElementById("last_name_input").value = "";
            }

            return;
        }

        
        function validate_email_field(){

            email_address_str = document.getElementById("email_input");
            email_regex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
            if(!email_address_str.value.match(email_regex)){

                alert("Email address is not in the right format.");

                document.getElementById("email_input").value= "";

            }

            return;
        }

        function validate_grad_year(){

            grad_year_str = document.getElementById("grad_year_input").value

            if (!/^[0-9]{4}$/.test(grad_year_str)){
                alert("Invalid graduation year.");

                document.getElementById("grad_year_input").value="";
            }

        }

        function validate_likes_field(){

            // ASSUMPTION - At least 2 checkbox are checked.

            var count = 0;

            
            input_checkboxes = document.getElementsByName("likes");
            for(var i = 0; i<input_checkboxes.length; i++){
                if (input_checkboxes[i].checked == true){
                    count++;
                }
            }

            if (count<2){
                alert("Two checkboxes must be checked.");
            }

        }


        function validate_address(){
            
            // Validate street address.
            street_address_str = document.getElementById("street_address_input").value;
            if (!/^[A-Za-z0-9 ]*$/.test(street_address_str)){
                alert("Street address can only contain alphanumeric values.");

                // Clear first name input field.
                document.getElementById("street_address_input").value = "";

            }

            // Validate city input.
            city_str = document.getElementById("city_input").value;
            if (!/^[A-Za-z]*$/.test(city_str)) {
                alert("City can only contain alphabetical values.");

                // Clear first name input field.
                document.getElementById("city_input").value = "";

            }

            // Validate state.
            state_str = document.getElementById("state_input").value;
            if (!/^[A-Za-z]*$/.test(state_str)) {
                alert("State can only contain alphabetical values.");

                // Clear first name input field.
                document.getElementById("state_input").value = "";

            }

            // Validate Zip code.
            zip_str = document.getElementById("zip_input").value;
            if (!/^[0-9]*$/.test(zip_str)) {
                alert("Zip can only contain numerical values.");

                // Clear first name input field.
                document.getElementById("zip_input").value = "";

            }

            
        }
        zip_url = "/data/zip_codes.json"

        function validateZip(zip) {

            var params = '[{"param": "zipcodes", "value": "' + zip + '"}]';
            callWebService("validateZip", params, showCityState);

        }

        function callWebService(method, paramString, callBack){


            alert("Entered callwebservice");
            console.log("Hello world.");
            var requestURL = zip_url + "/" + method;
            var params = paramString.parseJSON();
            alert(params);
            
            alert("before params");
            // build param string to add to url
            for(var i=0; i<params.length; i++){
                // checks the first parameter and adds to request url.
                if(i==0){
                    requestURL= requestURL + "?" + params[i].param + "=" + params[i].value;
                }else{ // not the first param
                    requestURL = requestURL + "&" + params[i].param + "=" + params[i].value;
                }
                alert("param running");
            }

            alert("Passed params");

            // make async request
            try{
                var asyncRequest = new XMLHttpRequest();

                // set callback function.
                asyncRequest.onreadystatechange= function(){
                    callBack(asyncRequest);
                };

                // send async request
                asyncRequest.open("GET", requestURL, true);
                asyncRequest.setRequestHeader("Accept", "application/json; charset=utf-8");
                asyncRequest.send(); // Send the request.

                alert("Sent xml request");
            }//end try
            catch(exception){
                alert("Request failed");
            }

        }

        function showCityState(asyncRequest){
            document.getElementById("validateZip").innerHTML = "Checking Zip";

            // if sucessful request, process response
            if (asyncRequest.readyState==4){
                if(asyncRequest.status ==200){
                    // convert json to obj
                    var data = asyncRequest.responseText.parseJSON();

                    // zip in json.
                    if(date.validity =="valid"){
                        // zipValid = true;

                        document.getElementById('validateZip').innerHTML= "";
                        document.getElementById("city_input").innerHTML = data.city;
                        document.getElementById("state_input").innerHTML = data.state;
                    }
                    else{
                        document.getElementById("validateZip").innerHTML = data.ErrorText;
                        
                        // Clear state/city if exits.
                        document.getElementById("city_input").innerHTML = data.city;
                        document.getElementById("state_input").innerHTML = data.state;

                    }
                } else if (asyncRequest.status == 500) {
                    document.getElementById('validateZip').innerHTML = "Zip validation service is not available.";
                }
            }
            }

    </script>

</body>

</html>